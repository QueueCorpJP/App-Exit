// Next.jsã®instrumentationãƒ•ãƒƒã‚¯
export async function register() {
  if (process.env.NEXT_RUNTIME === 'nodejs') {
    // Node.jsç’°å¢ƒã§ã®ã¿fsã¨pathã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
    const fs = await import('fs');
    const path = await import('path');

    // Supabaseã®åˆæœŸåŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡ºã™ã‚‹é–¢æ•°
    function detectSupabaseInitialization() {
      const supabasePatterns = [
        /createClient\s*\(/,
        /supabase\s*=\s*createClient/,
        /@supabase\/supabase-js/,
        /new\s+SupabaseClient/,
        /supabaseUrl.*supabaseAnonKey/
      ];

      const projectRoot = path.join(process.cwd());
      const foundFiles: string[] = [];

      function scanDirectory(dir: string) {
        try {
          const files = fs.readdirSync(dir);

          for (const file of files) {
            const filePath = path.join(dir, file);
            const stat = fs.statSync(filePath);

            if (stat.isDirectory() && !file.startsWith('.') && file !== 'node_modules') {
              scanDirectory(filePath);
            } else if (file.endsWith('.ts') || file.endsWith('.tsx') || file.endsWith('.js') || file.endsWith('.jsx')) {
              try {
                const content = fs.readFileSync(filePath, 'utf-8');

                // Supabaseã®åˆæœŸåŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
                const hasSupabaseInit = supabasePatterns.some(pattern => pattern.test(content));

                if (hasSupabaseInit) {
                  const relativePath = path.relative(projectRoot, filePath);
                  foundFiles.push(relativePath);
                }
              } catch (error) {
                // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
              }
            }
          }
        } catch (error) {
          // ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªèª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
        }
      }

      scanDirectory(projectRoot);
      return foundFiles;
    }

    // é‡è¤‡æ¤œå‡ºã¨ãƒ­ã‚°å‡ºåŠ›
    function checkSupabaseDuplication() {
      console.log('ğŸ” Supabaseã®åˆæœŸåŒ–é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’é–‹å§‹ã—ã¾ã™...');

      const supabaseFiles = detectSupabaseInitialization();

      if (supabaseFiles.length === 0) {
        console.log('âœ… Supabaseã®åˆæœŸåŒ–ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
        return;
      }

      if (supabaseFiles.length === 1) {
        console.log(`âœ… Supabaseã®åˆæœŸåŒ–ã¯1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã®ã¿æ¤œå‡ºã•ã‚Œã¾ã—ãŸ: ${supabaseFiles[0]}`);
        return;
      }

      // é‡è¤‡ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆ
      console.log('âš ï¸  Supabaseã®åˆæœŸåŒ–ãŒè¤‡æ•°ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§æ¤œå‡ºã•ã‚Œã¾ã—ãŸï¼');
      console.log('ğŸ“ é‡è¤‡ã—ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«:');

      supabaseFiles.forEach((file, index) => {
        console.log(`   ${index + 1}. ${file}`);
      });

      console.log('\nğŸ’¡ æ¨å¥¨äº‹é …:');
      console.log('   - Supabaseã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯1ã¤ã®ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¾‹: lib/supabase.tsï¼‰ã§åˆæœŸåŒ–ã—ã¦ãã ã•ã„');
      console.log('   - ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ãã®ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¦ä½¿ç”¨ã—ã¦ãã ã•ã„');
      console.log('   - é‡è¤‡ã™ã‚‹åˆæœŸåŒ–ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„');

      // è©³ç´°ãªé‡è¤‡ç®‡æ‰€ã®è¡¨ç¤º
      console.log('\nğŸ“‹ å„ãƒ•ã‚¡ã‚¤ãƒ«ã®è©³ç´°:');
      supabaseFiles.forEach(file => {
        try {
          const fullPath = path.join(process.cwd(), file);
          const content = fs.readFileSync(fullPath, 'utf-8');
          const lines = content.split('\n');

          console.log(`\nğŸ“„ ${file}:`);
          lines.forEach((line, index) => {
            if (line.includes('createClient') ||
                line.includes('@supabase/supabase-js') ||
                line.includes('supabaseUrl') ||
                line.includes('supabaseAnonKey')) {
              console.log(`   è¡Œ ${index + 1}: ${line.trim()}`);
            }
          });
        } catch (error) {
          console.log(`   âŒ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼: ${file}`);
        }
      });
    }

    checkSupabaseDuplication();
  }
}