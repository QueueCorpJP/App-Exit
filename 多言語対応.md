ğŸŒ Next.jsï¼ˆnext-intlï¼‰ Ã— Supabase Auth ã§å®Ÿç¾ã™ã‚‹
â€œæœ€é©ãªå¤šè¨€èªã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ§‹æˆâ€

æœ¬æ§‹æˆã¯ä»¥ä¸‹ã‚’æº€ãŸã™ï¼š

middleware ã‚’è»½é‡ã®ã¾ã¾ç¶­æŒ

DB ã‚¢ã‚¯ã‚»ã‚¹ãªã—ã§ locale åˆ¤å®šå¯èƒ½

ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨€èªè¨­å®šã‚’æ°¸ç¶šåŒ–

ãƒ‡ãƒã‚¤ã‚¹é–“ã§è¨€èªè¨­å®šãŒåŒæœŸ

next-intl ã¨å®Œå…¨äº’æ›

URL ãƒ‘ã‚¹ã«ã‚ˆã‚‹ i18n ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

SSR/RSC å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§ locale ã‚’å–å¾—å¯èƒ½

ğŸ§© å…¨ä½“æ§‹æˆã®æ¦‚è¦
[User Profile (Supabase)]  â† è¨€èªã® source of truth
        â”‚
        â–¼
[Supabase Auth JWT] â† lang ã‚’ custom claim ã¨ã—ã¦åŸ‹ã‚è¾¼ã¿
        â”‚
        â–¼
[Next.js ã‚µãƒ¼ãƒãƒ¼/RSC] â† JWT ã‹ã‚‰ lang ã‚’å–å¾—
        â”‚
        â–¼
[Cookie ã« locale ä¿å­˜ (ä¿å­˜å…ˆ)] 
        â”‚
        â–¼
[next-intl Middleware] â† Cookie ã® locale ã®ã¿ã‚’è¦‹ã‚‹ï¼ˆè»½é‡ï¼‰
        â”‚
        â–¼
[URL ãƒ‘ã‚¹è£œæ­£ /ja/... /en/...]
        â”‚
        â–¼
[next-intl Provider] â† locale ã«å¿œã˜ãŸè¾æ›¸ã‚’è‡ªå‹•ãƒ­ãƒ¼ãƒ‰
        â”‚
        â–¼
[UI Components] â† useTranslations() ã™ã‚‹ã ã‘

ğŸ“ 1. Supabase Profiles ãƒ†ãƒ¼ãƒ–ãƒ«ã« lang ã‚’ä¿å­˜

ä¾‹ï¼š

ALTER TABLE profiles ADD COLUMN lang text DEFAULT 'ja';

ğŸ” 2. Supabase Auth ã® JWT ã«è¨€èªã‚’åŸ‹ã‚è¾¼ã‚€ï¼ˆcustom claimsï¼‰

auth.users ã«ä¿å­˜ã™ã‚‹ã‚ˆã‚Šã€JWT ã«è¨€èªã‚’å…¥ã‚Œã‚‹æ–¹ãŒåŠ¹ç‡çš„ã€‚

SQLï¼ˆè‡ªå‹•ã§åŸ‹ã‚è¾¼ã‚€ï¼‰
create or replace function auth.jwt_custom_claims(uid uuid)
returns jsonb language sql stable as $$
  select jsonb_build_object(
    'lang', (select lang from profiles where id = uid)
  );
$$;


ã“ã‚Œã§ãƒ­ã‚°ã‚¤ãƒ³æ™‚ã«è‡ªå‹•ã§ JWT ã« lang ãŒå…¥ã‚‹ã€‚

ğŸ§­ 3. Next.js middleware ã¯ Cookie ã ã‘è¦‹ã‚‹ï¼ˆdecode ã—ãªã„ï¼‰

Supabase ã® JWT ã¯ decode ã—ãªã„ã€‚
middleware ã§ã¯ DB ã‚¢ã‚¯ã‚»ã‚¹ã—ãªã„ã€‚

// middleware.ts
import createMiddleware from 'next-intl/middleware';

export default createMiddleware({
  locales: ['ja', 'en'],
  defaultLocale: 'ja',
  localePrefix: 'always'
});

export const config = {
  matcher: ['/((?!api|_next|.*\\..*).*)']
};


â†’ ã“ã® middleware ã¯ Cookie ã® locale ã‚’æœ€å„ªå…ˆã§å‚ç…§
ï¼ˆnext-intl ãŒè‡ªå‹•ã§è¡Œã†ï¼‰

middleware ã¯è¶…è»½é‡ã®ã¾ã¾ä¿ãŸã‚Œã‚‹ã€‚

ğŸ“¦ 4. ã‚µãƒ¼ãƒãƒ¼/RSC å´ã§ JWT ã‚’ decode ã—ã¦ locale ã‚’å–å¾—

Next.js ã®ã‚µãƒ¼ãƒãƒ¼ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã§ JWT ã‚’èª­ã¿ã€ lang ã‚’å–å¾—ï¼š

import { cookies } from 'next/headers';
import { decodeJwt } from 'jose';

export async function getLocaleFromJWT() {
  const token = cookies().get('sb-access-token')?.value;
  if (!token) return null;

  const payload = decodeJwt(token);
  return payload.lang || null;
}

ğŸŒ 5. åˆå›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã« Cookie ã« locale ã‚’ã‚»ãƒƒãƒˆï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ï¼‰

JWT ã«å…¥ã£ã¦ã„ã‚‹ lang ã‚’ Cookie ã«æ›¸ãè¾¼ã‚€ï¼ˆémiddlewareï¼‰ï¼š

'use server';

import { cookies } from 'next/headers';

export async function syncLocaleCookie() {
  const locale = await getLocaleFromJWT();
  if (locale) {
    cookies().set('locale', locale, { path: '/' });
  }
}


â†’ middleware ãŒå‚ç…§ã™ã‚‹ locale ãŒç¢ºå®šã—ã€URL ã‚‚æ­£ã—ããƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã•ã‚Œã‚‹ã€‚

ğŸ“˜ 6. next-intl ãŒ locale ã«å¿œã˜ã¦è¾æ›¸ã‚’è‡ªå‹•ãƒ­ãƒ¼ãƒ‰

app/[locale]/layout.tsx ã§è¾æ›¸èª­ã¿è¾¼ã¿ï¼š

import { NextIntlClientProvider } from 'next-intl';

export default async function RootLayout({ children, params }) {
  const messages = (await import(`../../locales/${params.locale}.json`)).default;

  return (
    <NextIntlClientProvider messages={messages} locale={params.locale}>
      {children}
    </NextIntlClientProvider>
  );
}

ğŸ¨ 7. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå´ã¯ useTranslations() ã‚’å‘¼ã¶ã ã‘
import { useTranslations } from 'next-intl';

export default function Page() {
  const t = useTranslations('home');

  return <h1>{t('welcome')}</h1>;
}

ğŸ¯ ã¾ã¨ã‚ï¼šã“ã®æ§‹æˆãŒâ€œæœ€é©ãªç†ç”±â€

middleware ã¯æœ€è»½é‡ã§è² è·ã‚¼ãƒ­ï¼ˆDBã‚¢ã‚¯ã‚»ã‚¹ãªã—ï¼‰

JWT ã¯å…¨ãƒ¬ã‚¤ãƒ¤ãƒ¼ã§å‚ç…§å¯èƒ½ï¼ˆSSR/RSC/Edge/FWï¼‰

è¨€èªè¨­å®šã¯ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«é›†ç´„ï¼ˆå”¯ä¸€ã®çœŸå®Ÿï¼‰

æ›´æ–°æ™‚ã‚‚ JWT ã‚’æ›´æ–°ã™ã‚‹ã ã‘ã§åŒæœŸ

next-intl ã® i18n ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¨å®Œå…¨äº’æ›

éãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ Cookie + Accept-Language ã§å¯¾å¿œ

ï¼ ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ—ãƒ©ã‚¤ã‚ºç´šã® i18n è¨­è¨ˆã®æ­£è§£