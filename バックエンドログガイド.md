# ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰è©³ç´°ãƒ­ã‚°ã‚¬ã‚¤ãƒ‰

## ğŸ“‹ è¿½åŠ ã—ãŸãƒ­ã‚°æ©Ÿèƒ½

æŠ•ç¨¿ä½œæˆæ™‚ã®å•é¡Œã‚’è¨ºæ–­ã™ã‚‹ãŸã‚ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«**è©³ç´°ãªãƒ­ã‚°**ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚

---

## ğŸ” ãƒ­ã‚°ã®å ´æ‰€ã¨å†…å®¹

### 1. ãƒ«ãƒ¼ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ (`routes.go`)

```
========== ROUTE HANDLER: /api/posts ==========
[ROUTES] Method: POST, Path: /api/posts
[ROUTES] Remote Addr: 127.0.0.1:12345
[ROUTES] Content-Type: application/json
[ROUTES] âœ“ POST request detected - applying auth middleware
========== ROUTE HANDLER END ==========
```

**ç¢ºèªé …ç›®**:
- ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«åˆ°é”ã—ã¦ã„ã‚‹ã‹
- ãƒ¡ã‚½ãƒƒãƒ‰ãŒæ­£ã—ã„ã‹ (POST)
- Content-TypeãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹

---

### 2. èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ (`middleware/auth.go`)

```
========== AUTH MIDDLEWARE START ==========
[AUTH] Request: POST /api/posts
[AUTH] Remote Addr: 127.0.0.1:12345
[AUTH] Headers: map[Accept:... Authorization:Bearer eyJhbG... Content-Type:application/json]
[AUTH] âœ“ Authorization header found: Bearer eyJhbG...
[AUTH] âœ“ Token extracted (length: 856, segments: 3)
[AUTH] Parsing JWT token...
[AUTH] âœ“ JWT token parsed successfully
[AUTH] âœ“ Token verified for user: abc123-def456 (email: user@example.com, role: authenticated)
[AUTH] Generating impersonate JWT for RLS operations...
[AUTH] âœ“ Generated impersonate JWT (length: 234)
[AUTH] âœ“ Context populated with user info
========== AUTH MIDDLEWARE END (SUCCESS) ==========
```

**ç¢ºèªé …ç›®**:
- âœ… Authorization ãƒ˜ãƒƒãƒ€ãƒ¼ãŒå­˜åœ¨ã™ã‚‹ã‹
- âœ… ãƒˆãƒ¼ã‚¯ãƒ³ãŒæ­£ã—ã„å½¢å¼ã‹ (3ã¤ã®ã‚»ã‚°ãƒ¡ãƒ³ãƒˆ)
- âœ… JWT ãƒ‘ãƒ¼ã‚¹ãŒæˆåŠŸã—ãŸã‹
- âœ… user_id ãŒå–å¾—ã§ããŸã‹
- âœ… impersonate JWT ãŒç”Ÿæˆã•ã‚ŒãŸã‹

**ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ­ã‚°ä¾‹**:
```
[AUTH] âŒ ERROR: Missing Authorization header
[AUTH] Available headers: map[Content-Type:application/json ...]
========== AUTH MIDDLEWARE END (FAILED) ==========
```

---

### 3. æŠ•ç¨¿ä½œæˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ (`handlers/post.go`)

```
========== CREATE POST START ==========
[POST /api/posts] Request received from 127.0.0.1:12345
[POST /api/posts] Content-Type: application/json
[POST /api/posts] Content-Length: 1234
[POST /api/posts] âœ“ User ID from context: abc123-def456
[POST /api/posts] âœ“ Impersonate JWT found (length: 234)
[POST /api/posts] Decoding request body...
[POST /api/posts] âœ“ Request decoded successfully
[POST /api/posts] Request payload: type=transaction, title=My App, body_length=500
[POST /api/posts] Validating request...
[POST /api/posts] âœ“ Validation passed
[POST /api/posts] Creating Supabase client with impersonate JWT...
[POST /api/posts] âœ“ Supabase client created
[POST /api/posts] Querying user organization...
[POST /api/posts] â„¹ï¸ User has no organization
[POST /api/posts] Inserting post into database...
[POST /api/posts] Post data: map[author_user_id:abc123 title:My App type:transaction ...]
[POST /api/posts] âœ“ Post insert query executed
[POST /api/posts] âœ“ Post created successfully with ID: post-123
[POST /api/posts] Inserting post details for type: transaction
[POST /api/posts] Post details data: map[app_name:MyApp monthly_revenue:100000 ...]
[POST /api/posts] âœ“ Post details inserted successfully
[POST /api/posts] Retrieving created post with ID: post-123
[POST /api/posts] âœ… CreatePost completed successfully
========== CREATE POST END (SUCCESS) ==========
```

**ç¢ºèªé …ç›®**:
- âœ… User ID ãŒã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰å–å¾—ã§ããŸã‹
- âœ… Impersonate JWT ãŒå­˜åœ¨ã™ã‚‹ã‹
- âœ… ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ãŒãƒ‡ã‚³ãƒ¼ãƒ‰ã§ããŸã‹
- âœ… ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãŒé€šã£ãŸã‹
- âœ… Supabase client ãŒä½œæˆã•ã‚ŒãŸã‹
- âœ… æŠ•ç¨¿ãŒæ­£å¸¸ã«æŒ¿å…¥ã•ã‚ŒãŸã‹
- âœ… æŠ•ç¨¿è©³ç´°ãŒæŒ¿å…¥ã•ã‚ŒãŸã‹ (transaction/secret ã®å ´åˆ)

**ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ­ã‚°ä¾‹**:
```
[POST /api/posts] âŒ ERROR: Failed to insert post: PGRST116 - syntax error
[POST /api/posts] Error type: *errors.errorString
========== CREATE POST END (FAILED) ==========
```

---

## ğŸ§ª ãƒ­ã‚°ã®ç¢ºèªæ–¹æ³•

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’èµ·å‹•

```bash
cd /mnt/c/Users/sekig/Downloads/appexit/backend
go run cmd/api/main.go
```

### æŠ•ç¨¿ã‚’ä½œæˆ

1. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§ `/projects/new` ã«ã‚¢ã‚¯ã‚»ã‚¹
2. ãƒ•ã‚©ãƒ¼ãƒ ã«å…¥åŠ›
3. ã€Œã‚¢ãƒ—ãƒªã‚’æŠ•ç¨¿ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯

### ãƒ­ã‚°ã‚’ç¢ºèª

ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ä»¥ä¸‹ã®ã‚ˆã†ãªå‡ºåŠ›ãŒè¡¨ç¤ºã•ã‚Œã¾ã™:

```
========== ROUTE HANDLER: /api/posts ==========
...
========== AUTH MIDDLEWARE START ==========
...
========== CREATE POST START ==========
...
```

---

## ğŸ”§ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### å•é¡Œ1: ãƒ­ã‚°ãŒå…¨ãè¡¨ç¤ºã•ã‚Œãªã„

**åŸå› **: ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã«åˆ°é”ã—ã¦ã„ãªã„

**ç¢ºèªé …ç›®**:
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ (`go run cmd/api/main.go`)
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã® `NEXT_PUBLIC_API_URL` ãŒæ­£ã—ã„ã‹
- ãƒ–ãƒ©ã‚¦ã‚¶ã® DevTools â†’ Network ã‚¿ãƒ–ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒé€ä¿¡ã•ã‚Œã¦ã„ã‚‹ã‹

---

### å•é¡Œ2: `[AUTH] âŒ ERROR: Missing Authorization header`

**åŸå› **: ãƒˆãƒ¼ã‚¯ãƒ³ãŒé€ä¿¡ã•ã‚Œã¦ã„ãªã„

**ç¢ºèªé …ç›®**:
1. ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ç¢ºèª
   - ãƒ–ãƒ©ã‚¦ã‚¶ã® DevTools â†’ Application â†’ Local Storage
   - `appexit-auth` ãŒå­˜åœ¨ã™ã‚‹ã‹
2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ­ã‚°ã‚’ç¢ºèª
   - Console â†’ `[API-CLIENT] Token found in Supabase session`
   - Console â†’ `[API-CLIENT] Authorization header set`
3. Network ã‚¿ãƒ–ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ç¢ºèª
   - `Authorization: Bearer ...` ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹

**è§£æ±ºç­–**:
- ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ â†’ å†ãƒ­ã‚°ã‚¤ãƒ³
- LocalStorage ã‚’ã‚¯ãƒªã‚¢: `localStorage.clear()`

---

### å•é¡Œ3: `[AUTH] âŒ ERROR: Token parsing failed`

**åŸå› **: ãƒˆãƒ¼ã‚¯ãƒ³ãŒç„¡åŠ¹ã¾ãŸã¯æœŸé™åˆ‡ã‚Œ

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ­ã‚°ã®è©³ç´°**:
```
[AUTH] Token string (first 100 chars): eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6...
[AUTH] JWT Secret length: 64
```

**ç¢ºèªé …ç›®**:
- `.env` ãƒ•ã‚¡ã‚¤ãƒ«ã® `SUPABASE_JWT_SECRET` ãŒæ­£ã—ã„ã‹
- Supabase Dashboard â†’ Settings â†’ API â†’ JWT Secret ã‚’ã‚³ãƒ”ãƒ¼
- ãƒˆãƒ¼ã‚¯ãƒ³ãŒæœŸé™åˆ‡ã‚Œã§ãªã„ã‹

**è§£æ±ºç­–**:
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã® `.env` ã‚’æ›´æ–°
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’å†èµ·å‹•
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§å†ãƒ­ã‚°ã‚¤ãƒ³

---

### å•é¡Œ4: `[POST /api/posts] âŒ ERROR: Failed to insert post`

**åŸå› **: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼

**ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ­ã‚°ã®è©³ç´°**:
```
[POST /api/posts] âŒ ERROR: Failed to insert post: PGRST116 - syntax error at or near "..."
[POST /api/posts] Error type: *errors.errorString
[POST /api/posts] Post data: map[author_user_id:abc123 title:My App ...]
```

**ç¢ºèªé …ç›®**:
1. Supabase Dashboard â†’ Database â†’ ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã‚’ç¢ºèª
   - `posts` ãƒ†ãƒ¼ãƒ–ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹
   - ã‚«ãƒ©ãƒ åãŒæ­£ã—ã„ã‹
2. RLS (Row Level Security) ãƒãƒªã‚·ãƒ¼ã‚’ç¢ºèª
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŠ•ç¨¿ã‚’ä½œæˆã§ãã‚‹æ¨©é™ãŒã‚ã‚‹ã‹
3. `Post data` ã®å†…å®¹ã‚’ç¢ºèª
   - å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹
   - ãƒ‡ãƒ¼ã‚¿å‹ãŒæ­£ã—ã„ã‹

**è§£æ±ºç­–**:
- Supabase Dashboard ã§ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ ã‚’ç¢ºèª
- RLS ãƒãƒªã‚·ãƒ¼ã‚’ä¿®æ­£
- å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 

---

### å•é¡Œ5: æŠ•ç¨¿ãŒç„¡é™ã«å¾…æ©Ÿã™ã‚‹ï¼ˆãƒ­ã‚°ãŒé€”ä¸­ã§æ­¢ã¾ã‚‹ï¼‰

**ãƒ­ã‚°ã®ä¾‹**:
```
[POST /api/posts] Inserting post into database...
[POST /api/posts] Post data: map[...]
(ã“ã“ã§æ­¢ã¾ã‚‹)
```

**åŸå› **: Supabase API ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ

**ç¢ºèªé …ç›®**:
- Supabase ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹
- `.env` ã® `SUPABASE_URL` ã¨ `SUPABASE_SERVICE_ROLE_KEY` ãŒæ­£ã—ã„ã‹
- ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒæ­£å¸¸ã‹

**è§£æ±ºç­–**:
- Supabase Dashboard ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
- ç’°å¢ƒå¤‰æ•°ã‚’ç¢ºèªã—ã¦å†èµ·å‹•
- ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèª

---

## ğŸ“Š æ­£å¸¸ãªãƒ­ã‚°ãƒ•ãƒ­ãƒ¼ã®ä¾‹

æŠ•ç¨¿ä½œæˆãŒ**æˆåŠŸã™ã‚‹å ´åˆ**ã€ä»¥ä¸‹ã®é †åºã§ãƒ­ã‚°ãŒå‡ºåŠ›ã•ã‚Œã¾ã™:

```
1. ========== ROUTE HANDLER: /api/posts ==========
   [ROUTES] âœ“ POST request detected

2. ========== AUTH MIDDLEWARE START ==========
   [AUTH] âœ“ Authorization header found
   [AUTH] âœ“ Token extracted
   [AUTH] âœ“ JWT token parsed successfully
   [AUTH] âœ“ Token verified for user
   [AUTH] âœ“ Generated impersonate JWT
   [AUTH] âœ“ Context populated
   ========== AUTH MIDDLEWARE END (SUCCESS) ==========

3. ========== CREATE POST START ==========
   [POST /api/posts] âœ“ User ID from context
   [POST /api/posts] âœ“ Impersonate JWT found
   [POST /api/posts] âœ“ Request decoded successfully
   [POST /api/posts] âœ“ Validation passed
   [POST /api/posts] âœ“ Supabase client created
   [POST /api/posts] âœ“ Post created successfully
   [POST /api/posts] âœ“ Post details inserted successfully
   [POST /api/posts] âœ… CreatePost completed successfully
   ========== CREATE POST END (SUCCESS) ==========
```

**ã™ã¹ã¦ã®ã‚¹ãƒ†ãƒƒãƒ—ã« âœ“ ã¾ãŸã¯ âœ… ãƒãƒ¼ã‚¯ãŒã‚ã‚Œã°æˆåŠŸã§ã™ï¼**

---

## ğŸ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚’èµ·å‹•
2. âœ… æŠ•ç¨¿ä½œæˆã‚’è©¦ã™
3. âœ… ãƒ­ã‚°ã‚’ç¢ºèª
4. âœ… ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Œã°ã€ä¸Šè¨˜ã®ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚’å‚ç…§
5. âœ… ãƒ­ã‚°ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å•é¡Œã‚’å ±å‘Šï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

**ãƒ­ã‚°ãŒè©³ç´°ã«å‡ºåŠ›ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã€å•é¡Œã®ç‰¹å®šãŒç°¡å˜ã«ãªã‚Šã¾ã™ï¼** ğŸ‰
